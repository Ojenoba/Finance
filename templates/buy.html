{% extends "layout.html" %}

{% block title %}
    Buy Stocks
{% endblock %}

{% block main %}
<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Buy Stocks</h2>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <!-- Use prefilled_symbol if provided -->
            <form action="{{ url_for('buy', symbol=prefilled_symbol) if prefilled_symbol else url_for('buy') }}"
                  method="post"
                  class="needs-validation"
                  novalidate
                  autocomplete="off">

                <!-- Stock Symbol Input -->
                <div class="mb-3 position-relative">
                    <label for="symbol" class="form-label">Stock Symbol</label>
                    <input autofocus class="form-control" id="symbol" name="symbol"
                           value="{{ prefilled_symbol or '' }}" placeholder="e.g. AAPL" type="text" required>
                    <div class="invalid-feedback">Please enter a valid stock symbol.</div>
                    
                    <!-- Suggestions dropdown -->
                    <div id="suggestions" class="list-group position-absolute w-100 shadow-sm" 
                         style="z-index: 1000; display: none;"></div>
                    
                    <!-- Price preview -->
                    <div id="price-preview" class="mt-2 text-muted"></div>
                </div>

                <!-- Shares Input -->
                <div class="mb-3">
                    <label for="shares" class="form-label">Number of Shares</label>
                    <input class="form-control" id="shares" name="shares" placeholder="e.g. 10" type="number" min="1" required>
                    <div class="invalid-feedback">Please enter a positive number of shares.</div>
                    
                    <!-- Total cost preview -->
                    <div id="cost-preview" class="mt-2 fw-bold text-primary"></div>
                </div>

                <!-- Buttons -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" type="submit">Buy</button>
                    <a href="javascript:history.back()" class="btn btn-outline-secondary">⬅️ Back</a>
                </div>
            </form>
        </div>
    </div>

</div>

<script>
    // Bootstrap form validation
    (function () {
        'use strict'
        const forms = document.querySelectorAll('.needs-validation')
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()

    // Autocomplete + Price Preview
    document.addEventListener("DOMContentLoaded", function() {
        const input = document.getElementById("symbol");
        const suggestionsBox = document.getElementById("suggestions");
        const pricePreview = document.getElementById("price-preview");
        const sharesInput = document.getElementById("shares");
        const costPreview = document.getElementById("cost-preview");
        let currentPrice = null;

        input.addEventListener("input", async function() {
            const query = input.value.trim();
            if (query.length < 1) {
                suggestionsBox.style.display = "none";
                pricePreview.textContent = "";
                return;
            }

            try {
                const response = await fetch(`/autocomplete?query=${encodeURIComponent(query)}`);
                const results = await response.json();

                suggestionsBox.innerHTML = "";
                if (results.length > 0) {
                    results.forEach(stock => {
                        const item = document.createElement("button");
                        item.type = "button";
                        item.className = "list-group-item list-group-item-action";
                        item.textContent = `${stock.symbol} - ${stock.name}`;
                        item.onclick = () => {
                            input.value = stock.symbol;
                            suggestionsBox.style.display = "none";
                            currentPrice = stock.price;
                            pricePreview.textContent = `Current Price: $${stock.price}`;
                            updateCostPreview();
                        };
                        suggestionsBox.appendChild(item);
                    });
                    suggestionsBox.style.display = "block";
                } else {
                    suggestionsBox.style.display = "none";
                    pricePreview.textContent = "";
                }
            } catch (err) {
                console.error("Autocomplete error:", err);
                suggestionsBox.style.display = "none";
                pricePreview.textContent = "";
            }
        });

        // Update cost preview when shares change
        sharesInput.addEventListener("input", updateCostPreview);

        function updateCostPreview() {
            const shares = parseInt(sharesInput.value);
            if (currentPrice && shares > 0) {
                const total = (shares * currentPrice).toFixed(2);
                costPreview.textContent = `Total Cost: $${total}`;
            } else {
                costPreview.textContent = "";
            }
        }

        document.addEventListener("click", function(e) {
            if (!suggestionsBox.contains(e.target) && e.target !== input) {
                suggestionsBox.style.display = "none";
            }
        });
    });
</script>
{% endblock %}