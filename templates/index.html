{% extends "layout.html" %}

{% block title %}
    Portfolio
{% endblock %}

{% block main %}
<div class="container mt-4">

    <!-- Summary Header Bar -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm text-center border-0 bg-light">
                <div class="card-body">
                    <h6 class="text-muted">Cash Balance</h6>
                    <h3 class="text-success fw-bold">{{ cash|usd }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm text-center border-0 bg-light">
                <div class="card-body">
                    <h6 class="text-muted">Grand Total</h6>
                    <h3 class="text-primary fw-bold">{{ grand_total|usd }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm text-center border-0 bg-light">
                <div class="card-body">
                    <h6 class="text-muted">Diversification Score</h6>
                    <h3 class="text-warning fw-bold">{{ diversification_score }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Header with quick actions -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">üìä Your Portfolio</h2>
        <div>
            <a class="btn btn-success btn-sm shadow-sm me-2" href="/add-funds">üí∞ Add Funds</a>
            <a class="btn btn-primary btn-sm shadow-sm" href="/export">‚¨áÔ∏è Export CSV</a>
        </div>
    </div>

    <!-- Portfolio Table -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Stock</th>
                        <th>Name</th>
                        <th>Shares</th>
                        <th>Price</th>
                        <th>Total Value</th>
                        <th>Gain/Loss</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stock in portfolio %}
                        <tr>
                            <td><span class="badge bg-secondary">{{ stock.symbol }}</span></td>
                            <td>{{ stock.name }}</td>
                            <td>{{ stock.shares }}</td>
                            <td>{{ stock.price|usd }}</td>
                            <td>{{ stock.total_value|usd }}</td>
                            <td>
                                {% if stock.gain_loss >= 0 %}
                                    <span class="text-success fw-bold">+{{ stock.gain_loss|usd }}</span>
                                {% else %}
                                    <span class="text-danger fw-bold">{{ stock.gain_loss|usd }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('buy', symbol=stock.symbol) }}" class="btn btn-sm btn-outline-success">Buy</a>
                                <a href="{{ url_for('sell', symbol=stock.symbol) }}" class="btn btn-sm btn-outline-danger">Sell</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mt-5">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="fw-bold">Portfolio Allocation</h4>
                    <canvas id="allocation-chart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="fw-bold">Performance Over Time</h4>
                    <canvas id="performance-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Insights Section -->
    <div class="card shadow-sm mt-5">
        <div class="card-body">
            <h4 class="fw-bold">Insights</h4>
            <ul class="list-group list-group-flush">
                {% if top_gainer %}
                    <li class="list-group-item text-success">üìà <strong>Top Gainer:</strong> {{ top_gainer.symbol }} (+{{ top_gainer.change|round(2) }}%)</li>
                {% endif %}
                {% if top_loser %}
                    <li class="list-group-item text-danger">üìâ <strong>Top Loser:</strong> {{ top_loser.symbol }} ({{ top_loser.change|round(2) }}%)</li>
                {% endif %}
                <li class="list-group-item">üß© <strong>Diversification Score:</strong> {{ diversification_score }}</li>
            </ul>
        </div>
    </div>

    <!-- News Feed -->
    <div class="card shadow-sm mt-5">
        <div class="card-body">
            <h4 class="fw-bold">Latest News</h4>
            <ul class="list-group list-group-flush">
                {% if news %}
                    {% for article in news %}
                        <li class="list-group-item">
                            üì∞ <a href="{{ article.url }}" target="_blank">{{ article.title }}</a>
                        </li>
                    {% endfor %}
                {% else %}
                    <li class="list-group-item text-muted">No news available.</li>
                {% endif %}
            </ul>
            <div class="mt-3 text-end">
                <a href="/news" class="btn btn-outline-primary btn-sm">View All News</a>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Portfolio Allocation Pie Chart
    const allocationCtx = document.getElementById('allocation-chart').getContext('2d');
    new Chart(allocationCtx, {
        type: 'pie',
        data: {
            labels: [{% for stock in portfolio %}"{{ stock.symbol }}",{% endfor %}],
            datasets: [{
                data: [{% for stock in portfolio %}{{ stock.total_value }},{% endfor %}],
                backgroundColor: ['#4caf50','#2196f3','#ff9800','#9c27b0','#f44336','#00bcd4']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' },
                title: { display: true, text: 'Portfolio Allocation' }
            }
        }
    });

    // Performance Line Chart
    const performanceCtx = document.getElementById('performance-chart').getContext('2d');
    new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: [{% for point in performance_history %}"{{ point.date }}",{% endfor %}],
            datasets: [{
                label: 'Portfolio Value',
                data: [{% for point in performance_history %}{{ point.value }},{% endfor %}],
                borderColor: '#2196f3',
                backgroundColor: 'rgba(33, 150, 243, 0.2)',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: { display: true, text: 'Performance Over Time' }
            },
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}